#!/usr/bin/python3
# -*- coding: utf-8 -*-


from sys import argv, exit
from re import search
from datetime import date
from markdown import markdown
from os.path import dirname
from os import chdir


def print_leaflet_gpx_routes_js():
    g_js = ''

    # gpx files are relative to the .trps file
    chdir(dirname(argv[1]))

    for d in map_data.values():
        for r in d['routes']:
            with open(r, 'r') as f:
                g_js += '`' + f.read() + '`,\n'

    print(g_js.rstrip(',\n'))


def print_leaflet_markers_js():
    m_js = ''

    for d in map_data.values():
        for m in d['markers']:
            m_js += '{ lat: ' + m['lat'] + ', lng: ' + m['lng'] + ", label: '" + m['txt'] + "', icon: '🤩' },\n"

    print(m_js.rstrip(',\n'))


def ordinal(n):
    if 10 <= n % 100 <= 20:
        suffix = 'th'
    else:
        suffix = {1: 'st', 2: 'nd', 3: 'rd'}.get(n % 10, 'th')
    return f"{n}{suffix}"


def add_map_data(data_content, data_type='markers'):
    if not day_count in map_data.keys():
        map_data[day_count] = {'markers': [], 'routes': [], 'todos': [], 'dones': [], 'date_pretty': current_date_pretty}

    try:
        map_data[day_count][data_type].append(data_content)
    except KeyError:
        print('Illegal data_type: ' + data_type)
        exit(1)

routes = [] # gpx file paths
i_md = '' # itinenary markdown
day_count = 0
current_date = False
current_date_pretty = False
last_date = False
map_data = {} # markers, routes etc for drawing map


if len(argv) != 2:
    print("Usage: tripsnip <tripsnip flavour markdown file>")
    exit(1)


with open(argv[1], 'r') as f:
    for l in f:
        l = l.strip()

        # parse line for tripsnip stuff

        if l.startswith('- todo:'):
            i_md += '- ' + l.lstrip('- todo:') + '\n'
            add_map_data(l.strip('- todo:'), data_type='todos')

        elif l.startswith('- done:'):
            i_md += '- <del>' + l.lstrip('- done:') + '</del>\n'
            add_map_data(l.strip('- done:'), data_type='dones')

        elif l.startswith('- marker:'):
            # format: ^- marker:<lat>,<lng> <name>
            match = search(r'^- marker:([0-9.]*),([0-9.]*)\ (.*)', l)

            try:
                i_md += '- ' + match.group(3) + '\n'

                marker = {'lat': match.group(1), 'lng': match.group(2), 'txt': match.group(3)}
            except AttributeError as e:
                print(l)
                exit(1)

            add_map_data(marker, data_type='markers')

        elif l.startswith('- route:'):
            add_map_data(l.lstrip('- route:'), data_type='routes')

        elif l.startswith('## '):
            match = search(r'^##\ ([0-9]{4})-([0-9]{2})-([0-9]{2})', l)

            if match:
                year = int(match.group(1))
                month = int(match.group(2))
                day = int(match.group(3))

                current_date = date(year, month, day)

                # verify dates are consecutive
                if last_date:
                    if abs((current_date - last_date).days) != 1:
                        print(f'Non consecutive dates: {last_date} and {current_date}')
                        exit(1)

                last_date = current_date
                current_date_pretty = f'{current_date.strftime('%a')} {ordinal(current_date.day)} {current_date.strftime('%b %Y')}, day {day_count + 1}'

                day_count += 1

                i_md += f'## {current_date_pretty}\n'
            else:
                i_md += l + '\n'

        else:
            i_md += l + '\n'

#import pprint
#pprint.pprint(map_data)

print('''
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Responsive Pane Layout</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
margin: 0;
font-family: sans-serif;
font-size: 12px;
}
h1 {
margin-top: 0;
color: #76AF5B;
}
h2 {
margin: 1em 0 0 0;
color: #465068;
}
del {
opacity: .4;
}
ul {
margin-top: .5em;
padding-left: 1em;
}
li {
margin-bottom: .5em;
}
.container {
display: flex;
height: 100vh;
}
.pane {
box-sizing: border-box;
overflow-y: auto;
}
.menu {
padding: 1em;
width: 30%;
}
.content {
background: #fff;
width: 70%;
position: relative;
}
/* Hide toggle button on wide screens */
#toggle-btn {
display: none;
padding: .4em;
background: #333;
color: white;
border: none;
width: 100%;
}
#map {
height: 100vh;
width: 100%;
}

.custom-marker {
position: relative;
width: 40px;
height: 40px;
background-image: url('data:image/svg+xml,<%3Fxml version="1.0" encoding="UTF-8"%3F><svg width="800px" height="800px" viewBox="0 0 15 15" version="1.1" id="marker" xmlns="http://www.w3.org/2000/svg"><path fill="salmon" id="path4133" d="M7.5,0C5.0676,0,2.2297,1.4865,2.2297,5.2703&%23xA;&%23x9;C2.2297,7.8378,6.2838,13.5135,7.5,15c1.0811-1.4865,5.2703-7.027,5.2703-9.7297C12.7703,1.4865,9.9324,0,7.5,0z"/></svg>');
background-size: cover;
background-repeat: no-repeat;
text-align: center;
line-height: 20px;
font-size: 13px;
}

.custom-marker span {
position: absolute;
top: 40%;
left: 50%;
transform: translate(-50%, -50%);
pointer-events: none;
color: white;
text-shadow:
-2px -2px 0 white,
2px -2px 0 white,
-2px 2px 0 white,
2px 2px 0 white;
}

#map-cursor {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
pointer-events: none;
font-size: 24px;
color: red;
z-index: 1000; /* above map tiles */
user-select: none;
}

#map-coords {
position: absolute;
bottom: 0;
left: 0;
color: black;
background-color: rgba(255, 255, 255, 0.8);
z-index: 1000; /* above map tiles */
font-size: 10px;
padding: .2em;
}
#copy-btn {
cursor: pointer;
}


/* Mobile layout (below 600px) */
@media (max-width: 600px) {
.container {
flex-direction: column;
}
.pane {
width: 100%;
display: none;
}
.pane.active {
display: block;
}
#toggle-btn {
display: block;
}
} /* @media mobile */
</style>
</head>
<body>
<button id="toggle-btn" onclick="togglePane()">📄</button>

<div class="container">
<div class="pane menu active" id="itinerary">
''')
print(markdown(i_md))
print('''
</div><!-- /menu -->
<div id="content" class="pane content">
  <div id="map"></div>
  <div id="map-cursor">+</div>
  <div id="map-coords">
    <span id="coords"></span>
    <span id="copy-btn" title="Copy to clipboard: Ctrl + Shift + C">📋</span>
  </div>
</div><!-- /content -->
</div><!-- /container -->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
<script>
function getTrailingEmoji(str) {
  // Use Unicode property escape for emojis
  // This regex looks for a single emoji at the end of the string
  const regex = /(\\p{Extended_Pictographic})\\s*$/u;

  const match = str.match(regex);
  return match ? match[1] : '';
}


 // Initialize the map
const map = L.map('map', {
  center: [48.8566, 2.3522],
  zoom: 13,
  zoomControl: false
});

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Master bounds object
  const allBounds = L.latLngBounds([]);

  // Marker data
  const markerData = [
''')
print_leaflet_markers_js()
print('''
];

// Add markers and expand bounds
  markerData.forEach(({ lat, lng, label}) => {
    const markerIcon = L.divIcon({
      className: '',
      html: `<div class="custom-marker"><span>` + getTrailingEmoji(label) + `</span></div>`,
      iconSize: [40, 40],
      iconAnchor: [20, 40],
    });

    const marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map)
      .bindTooltip(label, { direction: 'top' });
    allBounds.extend([lat, lng]);
  });

  // GPX tracks as inline strings
  const gpxTracks = [
''')
print_leaflet_gpx_routes_js()
print('''
];


  let loadedTracks = 0;

  // Load GPX routes
  gpxTracks.forEach(gpxString => {
    const blob = new Blob([gpxString], { type: 'application/gpx+xml' });
    const url = URL.createObjectURL(blob);

    new L.GPX(url, {
      async: true,
      marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
      }
    })
    .on('loaded', function(e) {
      allBounds.extend(e.target.getBounds());
      loadedTracks++;

      // Once all tracks are loaded, fit map to total bounds
      if (loadedTracks === gpxTracks.length) {
        map.fitBounds(allBounds);
      }
    })
    .addTo(map);
  });

// Function to update the center coordinates
function updateCenterCoords() {
  const center = map.getCenter();
  document.getElementById('coords').innerText =
    `${center.lat.toFixed(6)},${center.lng.toFixed(6)}`;
}

// Initial update
updateCenterCoords();

// Update on move or zoom
map.on('move', updateCenterCoords);
map.on('zoom', updateCenterCoords);

let showingMenu = true;

function togglePane() {
  const menu = document.getElementById('itinerary');
  const content = document.getElementById('content');
  const toggleBtn = document.getElementById('toggle-btn');

  showingMenu = !showingMenu;

  if (window.innerWidth <= 600) {
    if (showingMenu) {
      menu.classList.add('active');
      content.classList.remove('active');
      toggleBtn.innerHTML = '🧭';
    } else {
      menu.classList.remove('active');
      content.classList.add('active');
      toggleBtn.innerHTML = '📝';
      map.invalidateSize();
    }
  }
}

// Ensure correct pane is visible on resize
window.addEventListener('resize', () => {
  const menu = document.getElementById('itinerary');
  const content = document.getElementById('content');
  if (window.innerWidth > 600) {
    menu.classList.add('active');
    content.classList.add('active');
  } else {
    togglePane();  // Refresh display
  }
});

</script>
<script>
  document.getElementById('copy-btn').addEventListener('click', function () {
    const coords = document.getElementById('coords').textContent;
    navigator.clipboard.writeText(coords).then(() => {
      // Optional: feedback (brief icon/text change)
      const btn = this;
      const original = btn.textContent;
      btn.textContent = '✅';
      setTimeout(() => btn.textContent = original, 1000);
    });
  });


  // Keyboard shortcut: Ctrl + Shift + C
  document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && e.shiftKey && e.code === 'KeyC') {
      e.preventDefault(); // prevent browser default (like opening dev tools)
      const coords = document.getElementById('coords').textContent;
      navigator.clipboard.writeText(coords);
    }
  });
</script>
</body>
</html>

''')
#import pprint
#pprint.pprint(map_data)
